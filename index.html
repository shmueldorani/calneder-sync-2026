<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×™×‘×•× ×©××•××œ - ×’×¨×¡×” 19.9</title>
    <style>
        :root {
            --primary: #2c3e50; --secondary: #34495e; --accent: #e74c3c;
            --success: #27ae60; --bg: #f4f7f6; --white: #ffffff; --border: #dcdde1;
            --chinese-marker: #ff7675;
            --status-red: #e74c3c; --status-orange: #e67e22; --status-green: #27ae60;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #2f3640; }
        #sidebar { width: 320px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 3px 0 15px rgba(0,0,0,0.2); z-index: 10; }
        .sidebar-header { text-align: center; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .bsh-text { font-size: 0.85rem; font-weight: normal; opacity: 0.8; display: block; margin-bottom: 5px; }
        .sidebar-header h2 { font-size: 2.3rem; margin: 0; letter-spacing: 1px; }
        
        /* ×—×™×¤×•×© */
        .search-container { position: relative; margin-bottom: 15px; }
        #sidebar-search { width: 100%; padding: 10px 35px 10px 10px; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 0.95rem; }
        .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); opacity: 0.5; }
        .clear-search { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-weight: bold; font-size: 1.2rem; opacity: 0.7; color: white; }

        .product-list { flex-grow: 1; overflow-y: auto; }
        .product-item { background: rgba(255,255,255,0.07); margin-bottom: 10px; padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .product-item:hover { background: rgba(255,255,255,0.15); }
        .prod-info { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; margin-right: 10px; }
        .prod-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ship-count { font-size: 0.75rem; opacity: 0.7; }
        
        /* ×—×™×¦×™× */
        .order-controls { display: flex; flex-direction: column; gap: 4px; }
        .order-btn { background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 3px; padding: 2px 5px; cursor: pointer; font-size: 0.65rem; }
        .order-btn:hover { background: var(--success); }

        .sidebar-footer { border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
        .footer-btn { width: 100%; padding: 14px; margin-bottom: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1rem; }
        .btn-tasks { background: #8e44ad; color: white; }
        .btn-cash { background: #f1c40f; color: #2c3e50; }
        
        #main-content { flex: 1; overflow-y: auto; padding: 25px; }
        .main-title { text-align: center; color: var(--primary); font-size: 2rem; font-weight: 900; margin-bottom: 25px; border-bottom: 3px solid var(--success); display: block; width: fit-content; margin-left: auto; margin-right: auto; padding-bottom: 5px; }
        
        /* ×œ×•×— ×©× ×” */
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }
        .month-card { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #eaebed; display: flex; flex-direction: column; min-height: 520px; }
        .month-header { text-align: center; margin-bottom: 10px; background: #f8f9fa; padding: 8px; border-radius: 8px; border: 1px solid #eee; }
        .month-title { font-size: 1.1rem; font-weight: 900; color: var(--primary); }
        .year-separator { grid-column: 1 / -1; background: var(--primary); color: white; padding: 20px; text-align: center; font-size: 2.2rem; font-weight: 900; border-radius: 15px; margin: 40px 0 10px 0; border: 4px solid var(--success); }
        .days-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.9rem; font-weight: 900; color: #000; background: #e8eaed; padding: 8px 0; border-radius: 5px; margin-bottom: 8px; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-cell { height: 48px; border: 1px solid #f1f2f6; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.9rem; border-radius: 4px; position: relative; }
        .day-cell.arrival-day { background: #dff9fb !important; border: 2.5px solid var(--success) !important; color: #1e6b3e !important; font-weight: 900; }
        .day-cell.chinese { background: var(--chinese-marker) !important; color: white !important; font-weight: bold; }
        .day-cell.holiday { background: #fff5f5; border: 1.5px solid #ffcccc; color: var(--accent); font-weight: 900; }
        .holiday-label { font-size: 0.5rem; position: absolute; bottom: 2px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; font-weight: bold; }
        
        /* ××©×™××•×ª ×•×¦×‘×¢×™× */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal { background: white; width: 94%; max-width: 1150px; height: 85vh; border-radius: 20px; padding: 25px; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 15px; left: 15px; font-size: 2.5rem; cursor: pointer; color: #bdc3c7; line-height: 1; }
        .ships-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .ship-cube, .task-cube { border-radius: 12px; padding: 18px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 8px; border: 1px solid var(--border); }
        .ship-cube { border-top: 6px solid var(--success); }
        .ship-not-ok { background: #ffeaea !important; border-top-color: var(--accent) !important; }
        
        /* ×ª×™×§×•×Ÿ ×¦×‘×¢×™ ×”××©×™××•×ª */
        .task-border-red { border: 5px solid var(--status-red) !important; }
        .task-border-orange { border: 5px solid var(--status-orange) !important; }
        .task-border-green { border: 5px solid var(--status-green) !important; }

        input, textarea, select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
        .btn-save-action { background: var(--success); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        .toast-msg {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #27ae60; color: white; padding: 12px 25px; border-radius: 50px;
            font-weight: bold; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none; animation: fadeInOut 3s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; bottom: 10px; }
            15% { opacity: 1; bottom: 20px; }
            85% { opacity: 1; bottom: 20px; }
            100% { opacity: 0; bottom: 10px; }
        }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; }
            #sidebar { width: 100% !important; padding: 10px; }
            .sidebar-header, .bsh-text, .search-container, .order-controls { display: none; }
            #main-content { padding: 10px; }
            .calendar-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-header">
            <span class="bsh-text">×‘×¡"×“ | ×‘×©× ×”' × ×¢×©×” ×•× ×¦×œ×™×—</span>
            <h2>× ×™×”×•×œ ×™×‘×•×</h2>
        </div>
        
        <button onclick="addMainShip()" style="width:100%; padding:15px; background:var(--success); color:white; border:none; border-radius:8px; cursor:pointer; margin-bottom:15px; font-weight:bold;">+ ×”×•×¡×¤×ª ×ª×™×§ ×¢×¡×§×”</button>
        
        <div class="search-container">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="sidebar-search" placeholder="×—×¤×© ×ª×™×§..." oninput="filterProds()">
            <span id="clear-search" class="clear-search" style="display:none; position:absolute; left:10px; top:5px;" onclick="resetSearch()">&times;</span>
        </div>

        <div id="product-list" class="product-list"></div>
        
        <div class="sidebar-footer">
            <button class="footer-btn btn-tasks" onclick="uiTasks()">ğŸ“ ×œ×•×— ××©×™××•×ª</button>
            <button class="footer-btn btn-cash" onclick="uiCash()">ğŸ’° ×ª×–×¨×™× ×™×‘×•×</button>
        </div>
    </div>
    
    <div id="main-content">
        <div class="main-title">×œ×•×— ×©× ×” ×©× ×ª×™ - ×¡×˜×˜×•×¡ ××›×•×œ×•×ª</div>
        <div id="calendar-grid" class="calendar-grid"></div>
    </div>
    
    <div id="overlay" class="overlay"><div class="modal"><span class="close-btn" onclick="closeModal()">&times;</span><div id="modal-content"></div></div></div>
    <div id="toast-container" class="toast-msg">âœ… × ×©××¨ ×‘×”×¦×œ×—×”!</div>

    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDkOd9JkH6TtNP1IrgnRFYoYuxoAvxOzYI",
            authDomain: "logistic-calender.firebaseapp.com",
            databaseURL: "https://logistic-calender-default-rtdb.firebaseio.com",
            projectId: "logistic-calender",
            storageBucket: "logistic-calender.appspot.com",
            messagingSenderId: "791878309038",
            appId: "1:791878309038:web:fb7dc79d4703abc8b5b93f"
        };
        
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        let data = { prods: [], tasks: [] };
        const mNames = ["×™× ×•××¨", "×¤×‘×¨×•××¨", "××¨×¥", "××¤×¨×™×œ", "×××™", "×™×•× ×™", "×™×•×œ×™", "××•×’×•×¡×˜", "×¡×¤×˜××‘×¨", "××•×§×˜×•×‘×¨", "× ×•×‘××‘×¨", "×“×¦××‘×¨"];
        const hNames = ["×˜×‘×ª-×©×‘×˜", "×©×‘×˜-××“×¨", "××“×¨-× ×™×¡×Ÿ", "× ×™×¡×Ÿ-××™×™×¨", "××™×™×¨-×¡×™×•×Ÿ", "×¡×™×•×Ÿ-×ª××•×–", "×ª××•×–-××‘", "××‘-××œ×•×œ", "××œ×•×œ-×ª×©×¨×™", "×ª×©×¨×™-×—×©×•×Ÿ", "×—×©×•×Ÿ-×›×¡×œ×•", "×›×¡×œ×•-×˜×‘×ª"];
        const dNames = ["×","×‘","×’","×“","×”","×•","×©"];
        
        // ×¨×©×™××ª ×—×’×™× ××¢×•×“×›× ×ª ×›×•×œ×œ 2027
        const holidays = { 
            "2026-03-03":"×¤×•×¨×™×","2026-04-01":"×¢×¨×‘ ×¤×¡×—","2026-04-02":"×¤×¡×— ×'","2026-04-08":"×¤×¡×— ×‘'","2026-05-23":"×©×‘×•×¢×•×ª","2026-09-12":"×¨××© ×”×©× ×”","2026-09-21":"×™×•× ×›×™×¤×•×¨","2026-09-26":"×¡×•×›×•×ª",
            "2027-03-23":"×¤×•×¨×™×","2027-04-21":"×¢×¨×‘ ×¤×¡×—","2027-04-22":"×¤×¡×— ×'","2027-04-23":"×—×•×œ ×”××•×¢×“","2027-04-24":"×—×•×œ ×”××•×¢×“","2027-04-25":"×—×•×œ ×”××•×¢×“","2027-04-26":"×—×•×œ ×”××•×¢×“","2027-04-27":"×—×•×œ ×”××•×¢×“","2027-04-28":"×¤×¡×— ×‘'",
            "2027-05-12":"×™×•× ×”×¢×¦×××•×ª","2027-06-11":"×©×‘×•×¢×•×ª","2027-10-02":"×¨××© ×”×©× ×” ×'","2027-10-03":"×¨××© ×”×©× ×” ×‘'","2027-10-11":"×™×•× ×›×™×¤×•×¨","2027-10-16":"×¡×•×›×•×ª ×'","2027-10-17":"×¡×•×›×•×ª ×‘'","2027-10-23":"×©××—×ª ×ª×•×¨×”"
        };

        function showSaveToast() {
            const toast = document.getElementById('toast-container');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        function save() {
            db.ref('calendar_final').set(data);
            showSaveToast();
        }

        db.ref('calendar_final').on('value', (s) => {
            const cloudData = s.val();
            if(cloudData) { 
                data = cloudData; 
                if (!data.prods) data.prods = [];
                if (!data.tasks) data.tasks = [];
                renderSidebar(); 
                renderCalendar(); 
            }
        });

        function filterProds() {
            const val = document.getElementById('sidebar-search').value.toLowerCase();
            document.getElementById('clear-search').style.display = val ? 'block' : 'none';
            renderSidebar(val);
        }

        function resetSearch() {
            document.getElementById('sidebar-search').value = '';
            filterProds();
        }

        function moveProd(idx, dir) {
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= data.prods.length) return;
            const temp = data.prods[idx];
            data.prods[idx] = data.prods[newIdx];
            data.prods[newIdx] = temp;
            save();
        }

        function renderSidebar(filter = '') {
            const listDiv = document.getElementById('product-list');
            if (!listDiv) return;
            listDiv.innerHTML = data.prods.map((p, i) => {
                if (filter && !p.name.toLowerCase().includes(filter)) return '';
                const sCount = (p.ships) ? p.ships.length : 0;
                return `
                <div class="product-item">
                    <div class="order-controls">
                        <button class="order-btn" onclick="event.stopPropagation(); moveProd(${i}, -1)">â–²</button>
                        <button class="order-btn" onclick="event.stopPropagation(); moveProd(${i}, 1)">â–¼</button>
                    </div>
                    <div class="prod-info" onclick="uiProd(${p.id})">
                        <span class="prod-name">${p.name}</span>
                        <span class="ship-count">${sCount} ×¢×¡×§××•×ª</span>
                    </div>
                </div>`;
            }).join('');
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid'); 
            if(!grid) return;
            grid.innerHTML = '';
            [2026, 2027].forEach(year => {
                if(year === 2027) grid.innerHTML += `<div class="year-separator">×©× ×ª 2027 ×‘×©×¢×” ×˜×•×‘×”</div>`;
                for (let m = 0; m < 12; m++) {
                    const arrivals = [];
                    data.prods.forEach(p => {
                        (p.ships || []).forEach(s => {
                            if(s.arr) {
                                const dObj = new Date(s.arr);
                                if(dObj.getFullYear() === year && dObj.getMonth() === m) {
                                    arrivals.push({ day: dObj.getDate(), name: s.t || p.name, cnt: s.cnt || '' });
                                }
                            }
                        });
                    });
                    arrivals.sort((a,b) => a.day - b.day);
                    grid.innerHTML += `<div class="month-card">
                        <div class="month-header"><div class="month-title">${mNames[m]} | ${hNames[m]} ${year}</div></div>
                        <div class="days-header">${dNames.map(d=>`<div>${d}</div>`).join('')}</div>
                        <div class="days-grid">${buildDays(year, m, arrivals.map(a=>a.day))}</div>
                        <div class="month-summary">
                            <div class="summary-title">ğŸ“‹ ×¤×™×¨×•×˜ ×”×’×¢×•×ª:</div>
                            ${arrivals.length > 0 ? arrivals.map(a => `<span class="arrival-row">×‘-<b>${a.day}</b>: ${a.name} ${a.cnt ? `(${a.cnt} ××›×•×œ×•×ª)` : ''}</span>`).join('') : '<span style="opacity:0.5;">××™×Ÿ ×”×’×¢×•×ª</span>'}
                        </div>
                    </div>`;
                }
            });
        }

        function buildDays(y, m, arrDays) {
            let h = ''; const first = new Date(y, m, 1).getDay(); const total = new Date(y, m+1, 0).getDate();
            for(let i=0; i<first; i++) h += '<div></div>';
            for(let d=1; d<=total; d++) {
                const isC = (y === 2026 && m === 1 && d >= 3 && d <= 17) || (y === 2027 && m === 1 && d >= 6 && d <= 20);
                const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasArr = arrDays.includes(d);
                h += `<div class="day-cell ${isC?'chinese':''} ${holidays[k]?'holiday':''} ${hasArr?'arrival-day':''}">
                    ${d} ${isC ? '<span class="holiday-label">×—×’ ×¡×™× ×™</span>' : ''}
                    ${holidays[k]?`<span class="holiday-label">${holidays[k]}</span>`:''}
                </div>`;
            }
            return h;
